name: Update plugin.stats.installations.plugin.url in urls.properties

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: "{{ .github.owner }}"
      repository: "{{ .github.repository }}"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "{{ .github.branch }}"

sources:
  latestPluginStatsUrl:
    kind: shell
    spec:
      command: "curl -s https://stats.jenkins.io/jenkins-stats/svg/ | grep -oP '\\d{6}-plugins.csv' | sort -r | head -n 1"
    transformers:
      - addprefix: "https://stats.jenkins.io/jenkins-stats/svg/"

targets:
  updateUrlsProperties:
    name: "Update plugin.stats.installations.plugin.url in urls.properties"
    kind: file
    spec:
      file: "plugin-modernizer-core/src/main/resources/urls.properties"
      matchpattern: "plugin.stats.installations.plugin.url=.*"
      replacepattern: "plugin.stats.installations.plugin.url={{ source \"latestPluginStatsUrl\" }}"
    sourceid: latestPluginStatsUrl
    scmid: default

actions:
  createPullRequest:
    kind: github/pullrequest
    scmid: default
    title: "Update plugin.stats.installations.plugin.url to {{ source \"latestPluginStatsUrl\" }}"
    spec:
      labels:
        - dependencies
        - updatecli
